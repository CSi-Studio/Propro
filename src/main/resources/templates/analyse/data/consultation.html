<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layouts/layout">
<!-- begin::Head -->
<head>
    <title>
        欢迎登陆西湖大学PECS分析平台
    </title>

    <link th:href="|${url}/assets/css/pagination.css|" rel="stylesheet" type="text/css"/>

</head>
<!-- end::Head -->
<!-- end::Body -->
<body>

<div class="m-subheader ">
    <div class="d-flex align-items-center">
        <div class="mr-auto">
            <h3 class="m-subheader__title m-subheader__title--separator">
                肽段检测会诊工具
            </h3>
        </div>
    </div>
</div>

<div class="m-content" layout:fragment="content">

    <div class="alert alert-danger" role="alert" th:if="${error_msg}" th:text="${error_msg}"></div>
    <div th:if="${errorList}" th:each="arrayS:${errorList}">
        <div class="alert alert-danger" role="alert" th:text="${arrayS}"></div>
    </div>

    <div class="alert alert-success" role="alert" th:if="${success_msg}" th:text="${success_msg}"></div>
    <div class="row">
        <div class="col-md-8">
            <div class="m-portlet__body">
                <div class="clearfix">
                    <form id="searchForm" method="post" role="form"
                          class="m-form m-form--fit m-form--label-align-right m-form--group-seperator-dashed"
                          th:action="@{/analyse/consultation}">
                        <input id="dataId" type="hidden" th:value="${dataId}" class="form-control" name="dataId">
                        <div class="form-group m-form__group row">
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        MzExtractWindow:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="mzExtractWindow"
                                       th:value="${mzExtractWindow}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        RtExtractWindow:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="rtExtractWindow"
                                       th:value="${rtExtractWindow}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        碎片最小长度:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="limitLength"
                                       th:value="${limitLength}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        Sigma:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="sigma"
                                       th:value="${sigma}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        Spacing:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="spacing"
                                       th:value="${spacing}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        Noise:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="noise"
                                       th:value="${noise}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="useGaussFilter"
                                               th:checked="${useGaussFilter}">
                                        是否使用高斯平滑
                                        <span></span>
                                    </label>
                                </div>
                            </div>

                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="useNoise"
                                               th:checked="${useNoise}">
                                        是否使用降噪处理
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="noUseForFill"
                                               th:checked="${noUseForFill}">
                                        不使用算法生成
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="noUseForLib"
                                               th:checked="${noUseForLib}">
                                        不使用标准库
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                            <!--<div class="input-group col-lg-2">-->
                                <!--<div class="m-checkbox-list">-->
                                    <!--<label class="m-checkbox">-->
                                        <!--<input type="checkbox" class="form-control m-input" name="useIsotope"-->
                                               <!--th:checked="${useIsotope}">-->
                                        <!--算法生成包含同位素-->
                                        <!--<span></span>-->
                                    <!--</label>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div class="input-group col-lg-2">-->
                                <!--<div class="m-checkbox-list">-->
                                    <!--<label class="m-checkbox">-->
                                        <!--<input type="checkbox" class="form-control m-input" name="onlyIsotope"-->
                                               <!--th:checked="${onlyIsotope}">-->
                                        <!--算法生成只包含同位素-->
                                        <!--<span></span>-->
                                    <!--</label>-->
                                <!--</div>-->
                            <!--</div>-->

                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="allCutInfo"
                                               th:checked="${allCutInfo}">
                                        每一次都重新计算所有片段
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-form__group row">

                        </div>
                        <div class="row">
                            <div class="col-1 row">
                                <div class="col-lg-12">
                                    <label>
                                        标准库
                                    </label>
                                    <div class="m-checkbox-list" th:each="dicCutInfo:${cutInfoFromDic}">
                                        <label class="m-checkbox m-checkbox--state-success">
                                            <input type="checkbox"
                                                   th:if="${usedCutInfos==null || usedCutInfos.contains(dicCutInfo)}"
                                                   th:checked="checked" th:name="|CUTINFO_${dicCutInfo}|"
                                                   th:text="${dicCutInfo}">
                                            <input type="checkbox"
                                                   th:unless="${usedCutInfos==null || usedCutInfos.contains(dicCutInfo)}"
                                                   th:name="|CUTINFO_${dicCutInfo}|" th:text="${dicCutInfo}">
                                            <span></span>
                                        </label>
                                    </div>
                                </div>
                                <!--<div class="col-12">-->
                                <!--<label>-->
                                <!--算法生成且命中片段-->
                                <!--</label>-->
                                <!--<div class="m-checkbox-inline" th:each="genCutInfo:${cutInfoFromGuessAndHit}">-->
                                <!--<label class="m-checkbox m-checkbox&#45;&#45;state-success">-->
                                <!--<input type="checkbox"-->
                                <!--th:if="${usedCutInfos==null || usedCutInfos.contains(genCutInfo)}"-->
                                <!--th:checked="checked" th:name="|CUTINFO_${genCutInfo}|"-->
                                <!--th:text="${genCutInfo}">-->
                                <!--<input type="checkbox"-->
                                <!--th:unless="${usedCutInfos==null ||usedCutInfos.contains(genCutInfo)}"-->
                                <!--th:name="|CUTINFO_${genCutInfo}|" th:text="${genCutInfo}">-->
                                <!--<span></span>-->
                                <!--</label>-->
                                <!--</div>-->
                                <!--</div>-->
                            </div>
                            <div class="col-11" id="chart" style="height: 1000px;">

                            </div>
                        </div>
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">
                                分析
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="col-12 row">
                <div class="m-portlet m-portlet--tab col-12">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                            <span class="m-portlet__head-icon m--hide">
                                <i class="la la-gear"></i>
                            </span>
                                <h3 class="m-portlet__head-text">诊断肽段: <span th:text="${peptideRef}"></span></h3>
                            </div>
                        </div>
                    </div>

                    <div class="m-portlet__body">
                        <div class="form-group m-form__group row">
                            <label for="id" class="col-3 col-form-label">
                                ID
                            </label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="id" name="id" readonly
                                       th:value="${overview?.id}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="id" class="col-3 col-form-label">卷积代号</label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="name" name="name" readonly
                                       th:value="${overview?.name}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="id" class="col-3 col-form-label">原始实验ID</label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="expId" name="expId" readonly
                                       th:value="${overview?.expId}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="library" class="col-3 col-form-label">关联标准库</label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="library" readonly
                                       th:value="|${overview?.libraryName}(${overview?.libraryId})|">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="ExtractWindow" class="col-3 col-form-label">原始RT/MZ卷积窗口</label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="ExtractWindow" readonly
                                       th:value="|${overview?.rtExtractWindow}/${overview?.mzExtractWindow}|">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="slopeIntercept" class="col-3 col-form-label">斜率/截距</label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="slopeIntercept" readonly
                                       th:value="|${exp?.slope}/${exp?.intercept}|">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="slopeIntercept" class="col-3 col-form-label">前体MZ</label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="slopeIntercept" readonly
                                       th:value="${peptide.mz}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="slopeIntercept" class="col-12 col-form-label" style="text-align: center;">
                                算法生成但未命中的片段</label>
                            <div class="m-checkbox-list" th:each="genCutInfo:${cutInfoFromGuess}">
                                <a class="m-checkbox m-checkbox--state-success" th:text="${genCutInfo}"></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 row">
                <div class="m-portlet m-portlet--tab col-12">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                            <span class="m-portlet__head-icon m--hide">
                                <i class="la la-gear"></i>
                            </span>
                                <h3 class="m-portlet__head-text">按片段搜索相似肽段(不包含Unimod,长度不能小于4)</span></h3>
                            </div>
                        </div>
                    </div>

                    <div class="m-portlet__body">
                        <input id="libraryId" type="hidden" th:value="${libraryId}" class="form-control"
                               name="libraryId">
                        <input id="precursorMz" type="hidden" th:value="${precursorMz}" class="form-control"
                               name="precursorMz">
                        <input id="experimentId" type="hidden" th:value="${expId}" class="form-control" name="expId">
                        <div class="form-group m-form__group row">
                            <label for="id" class="col-3 col-form-label">
                                肽段片段
                            </label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="fragmentSequence"
                                       name="fragmentSequence">
                            </div>
                        </div>
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="search()">
                                搜索
                            </button>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="slopeIntercept" class="col-12 col-form-label"
                                   style="text-align: center">搜索结果</label>
                            <div class="col-12" id="searchResult">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>


</body>

<th:block layout:fragment="script">
    <script th:src="|${url}/assets/js/echarts/echarts.min.js|" type="text/javascript"></script>
    <script th:src="|${url}/assets/js/echarts/dark.js|" type="text/javascript"></script>

    <script th:inline="javascript">

        function search() {
            var peptides;
            var searchResult = document.getElementById("searchResult");
            searchResult.innerText = "";
            var fragmentSequence = document.getElementById("fragmentSequence").value;
            var libraryId = document.getElementById("libraryId").value;
            var precursorMz = document.getElementById("precursorMz").value;
            var experimentId = document.getElementById("experimentId").value;
            $.ajax({
                type: "POST",
                url: "/library/search",
                data: {
                    fragmentSequence: fragmentSequence,
                    libraryId: libraryId,
                    experimentId: experimentId,
                    precursorMz: precursorMz
                },
                dataType: "json",
                async: false,
                success: function (result) {
                    if (result.success) {
                        peptides = result.model.peptides;
                        if (peptides == null || peptides.length === 0) {
                            searchResult.innerText = "No Similar Peptide";
                        } else {
                            var result = "";
                            for (var i = 0; i < peptides.length; i++) {
                                result += "<label>" + peptides[i] + "</label><br>";
                            }
                            searchResult.innerHTML = result;
                        }
                    }
                }
            });
        }

        /*<![CDATA[*/
        var data_rt = [[${rt}]];
        var cutinfo = [[${totalCutInfos}]];
        var intensity_arrays = [[${intensitiesList}]];
        /*]]>*/
        var chart;

        $(document).ready(function () {
            chart = echarts.init(document.getElementById('chart'));
            var intensity_series = [];
            for (var i = 0; i < intensity_arrays.length; i++) {
                intensity_series.push({
                    name: cutinfo[i],
                    type: 'line',
                    smooth: true,
                    data: intensity_arrays[i]
                });
            }
            option = {
                legend: {
                    data: cutinfo.sort(),
                    align: 'left'
                },
                dataZoom: [{
                    type: 'inside',
                    filterMode: 'empty',
                    start: (chart.getModel() && chart.getModel().getOption().dataZoom[0].start) ? chart.getModel().getOption().dataZoom[0].start : 0,
                    end: (chart.getModel() && chart.getModel().getOption().dataZoom[0].end) ? chart.getModel().getOption().dataZoom[0].end : 100
                }, {
                    type: 'slider'
                }],
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        var showBion = "";
                        var showYion = "";
                        params = params.sort(function (m, n) {
                            if (m.data < n.data) return -1;
                            else if (m.data > n.data) return 1;
                            else return 0
                        });

                        for (var i = 0; i < params.length; i++) {
                            if (params[i].data !== 0) {
                                if(params[i].seriesName.slice(0,1) === "b"){
                                    showBion += params[i].marker + params[i].seriesName + ':' + params[i].data + '<br>'
                                }else{
                                    showYion += params[i].marker + params[i].seriesName + ':' + params[i].data + '<br>'
                                }
                            }
                        }
                        return "<div class='row'><div class='col-6'>"+showBion+"</div><div class='col-6'>"+showYion+"</div></div>";
                    },
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                xAxis: {
                    data: data_rt,
                    silent: false,
                    splitLine: {
                        show: false
                    }
                },
                yAxis: {},
                series: intensity_series
            };

            chart.setOption(option, true);
        });


    </script>
</th:block>

<!-- end::Body -->
</html>
