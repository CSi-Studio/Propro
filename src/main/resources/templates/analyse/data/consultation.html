<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="~{layouts/layout}">
<!-- begin::Head -->
<head>
    <title th:text="#{title_welcome_to_propro}"></title>
    <link th:href="|${url}/assets/css/pagination.css|" rel="stylesheet" type="text/css"/>
</head>
<!-- end::Head -->
<!-- end::Body -->
<body>

<div class="m-subheader ">
    <div class="d-flex align-items-center">
        <div class="mr-auto">
            <h3 class="m-subheader__title m-subheader__title--separator" th:text="#{menu_peptide_clinic}">
            </h3>
        </div>
    </div>
</div>

<div class="m-content" layout:fragment="content">

    <div class="alert alert-danger" role="alert" th:if="${error_msg}" th:text="${error_msg}"></div>
    <div th:if="${errorList}" th:each="arrayS:${errorList}">
        <div class="alert alert-danger" role="alert" th:text="${arrayS}"></div>
    </div>

    <div class="alert alert-success" role="alert" th:if="${success_msg}" th:text="${success_msg}"></div>
    <div class="row">
        <div class="col-md-9">
            <div class="m-portlet__body">
                <div class="clearfix">
                    <form id="searchForm" method="post" role="form"
                          class="m-form m-form--fit m-form--label-align-right m-form--group-seperator-dashed"
                          th:action="@{/analyse/consultation}">
<!--                        <input id="dataId" type="hidden" th:value="${dataId}" class="form-control" name="dataId">-->
                        <div class="form-group m-form__group row">
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button" th:text="#{label_exp_id}"></button>
                                </div>
                                <input type="text" class="form-control m-input" name="expId"
                                       th:value="${expId}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button" th:text="#{label_associated_library}">
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="libraryId"
                                       th:value="${libraryId}">
                            </div>
                            <div class="input-group col-lg-4">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        targetRef:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="peptideRef"
                                       th:value="${peptideRef}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        Sigma:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="sigma"
                                       th:value="${sigma}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        Spacing:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="spacing"
                                       th:value="${spacing}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        MzExtractWindow:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="mzExtractWindow"
                                       th:value="${mzExtractWindow}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        RtExtractWindow:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="rtExtractWindow"
                                       th:value="${rtExtractWindow}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button" th:text="#{label_fragment_min_length}">
                                    </button>
                                </div>
                                <input type="number" th:max="${peptide?.sequence?.length()}" class="form-control m-input" name="limitLength"
                                       th:value="${limitLength}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="input-group-prepend">
                                    <button class="btn btn-success" type="button">
                                        Noise:
                                    </button>
                                </div>
                                <input type="text" class="form-control m-input" name="noise"
                                       th:value="${noise}">
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="allCutInfo"
                                               th:checked="${allCutInfo}" th:text="#{label_recalculate_per_time}">
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="noUseForLib"
                                               th:checked="${noUseForLib}" th:text="#{label_no_use_for_library_fill}">
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="useGaussFilter"
                                               th:checked="${useGaussFilter}" th:text="#{label_if_use_gauss_filter}">
                                        <span></span>
                                    </label>
                                </div>
                            </div>

                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="useNoise"
                                               th:checked="${useNoise}" th:text="#{label_if_use_data_denoising}">
                                        <span></span>
                                    </label>
                                </div>
                            </div>
                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="noUseForFill"
                                               th:checked="${noUseForFill}" th:text="#{label_no_use_for_algo_fill}">
                                        <span></span>
                                    </label>
                                </div>
                            </div>

                            <div class="input-group col-lg-2">
                                <div class="m-checkbox-list">
                                    <label class="m-checkbox">
                                        <input type="checkbox" class="form-control m-input" name="onlyOneCharge"
                                               th:checked="${onlyOneCharge}" th:text="#{label_only_one_charge}">
                                        <span></span>
                                    </label>
                                </div>
                            </div>


                            <div class="input-group-append">
                                <button class="btn btn-primary" type="submit" th:text="#{btn_analyse}"></button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-2 row">
                                <div class="col-lg-12">
                                    <label th:text="#{label_associated_library}">
                                    </label>
                                    <div class="m-checkbox-list" th:each="dicCutInfo:${cutInfoFromDic}">
                                        <label class="m-checkbox m-checkbox--state-success">
                                            <input type="checkbox"
                                                   th:if="${usedCutInfos==null || usedCutInfos.contains(dicCutInfo)}"
                                                   th:checked="checked" th:name="|CUTINFO_${dicCutInfo}|"
                                                   th:text="${dicCutInfo}">
                                            <input type="checkbox"
                                                   th:unless="${usedCutInfos==null || usedCutInfos.contains(dicCutInfo)}"
                                                   th:name="|CUTINFO_${dicCutInfo}|" th:text="${dicCutInfo}">
                                            <span></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="row" th:each="rt:${rtShapeScoreMap?.keySet()}">
                                        <label class="col-12 alert-success" th:if="${rtShapeScoreMap.get(rt) > 0.8}" th:text="|RT:${rt}|"></label>
                                        <label class="col-12 alert-danger" th:unless="${rtShapeScoreMap.get(rt) > 0.8}" th:text="|RT:${rt}|"></label>
                                        <label class="col-12 alert-success" style="text-align: left" th:if="${rtShapeScoreMap.get(rt) > 0.8}" th:text="${rtShapeScoreMap.get(rt)}"></label>
                                        <label class="col-12 alert-danger" style="text-align: left" th:unless="${rtShapeScoreMap.get(rt) > 0.8}" th:text="${rtShapeScoreMap.get(rt)}"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-10" id="chart" style="height: 600px;">

                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="col-12 row">
                <div class="m-portlet m-portlet--tab col-12">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                            <span class="m-portlet__head-icon m--hide">
                                <i class="la la-gear"></i>
                            </span>
                                <h3 class="m-portlet__head-text" th:text="#{label_peptide_reference}"><span th:text="${peptideRef}"></span></h3>
                            </div>
                        </div>
                    </div>

                    <div class="m-portlet__body">
                        <div class="form-group m-form__group row">
                            <label for="experimentName" class="col-3 col-form-label" th:text="#{label_exp_name}"></label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="experimentName" readonly
                                       th:value="${exp?.name}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="slopeIntercept" class="col-3 col-form-label" th:text="#{label_slope_intercept}"></label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="slopeIntercept" readonly
                                       th:value="|${exp?.irtResult?.si?.slope}/${exp?.irtResult?.si?.intercept}|">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="precursorMz" class="col-3 col-form-label" th:text="#{label_precursor_mz}"></label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="precursorMz" readonly
                                       th:value="${peptide?.mz}">
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="slopeIntercept" class="col-12 col-form-label" style="text-align: center;" th:text="#{label_algo_fill_but_not_hit}">
                            </label>
                            <div class="m-checkbox-list" th:each="genCutInfo:${cutInfoFromGuess}">
                                <a class="m-checkbox m-checkbox--state-success" th:text="${genCutInfo}"></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 row">
                <div class="m-portlet m-portlet--tab col-12">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                            <span class="m-portlet__head-icon m--hide">
                                <i class="la la-gear"></i>
                            </span>
                                <h3 class="m-portlet__head-text" th:text="#{label_search_by_similar_peptide}"></h3>
                            </div>
                        </div>
                    </div>

                    <div class="m-portlet__body">
                        <input id="libraryId" type="hidden" th:value="${libraryId}" class="form-control"
                               name="libraryId">
                        <input id="precursorMz" type="hidden" th:value="${peptide?.mz}" class="form-control"
                               name="precursorMz">
                        <input id="experimentId" type="hidden" th:value="${expId}" class="form-control" name="expId">
                        <div class="form-group m-form__group row">
                            <label for="fragmentSequence" class="col-3 col-form-label" th:text="#{label_fragment_sequence}">
                            </label>
                            <div class="col-9">
                                <input type="text" class="form-control m-input" id="fragmentSequence"
                                       name="fragmentSequence">
                            </div>
                        </div>
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="search()" th:text="#{btn_search}">
                            </button>
                        </div>
                        <div class="form-group m-form__group row">
                            <label for="slopeIntercept" class="col-12 col-form-label"
                                   style="text-align: center" th:text="#{label_search_result}"></label>
                            <div class="col-12" id="searchResult">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>


</body>

<th:block layout:fragment="script">
    <script th:src="|${url}/assets/js/echarts/echarts.min.js|" type="text/javascript"></script>
    <script th:src="|${url}/assets/js/echarts/dark.js|" type="text/javascript"></script>

    <script th:inline="javascript">

        function search() {
            var peptides;
            var searchResult = document.getElementById("searchResult");
            searchResult.innerText = "";
            var fragmentSequence = document.getElementById("fragmentSequence").value;
            var libraryId = document.getElementById("libraryId").value;
            var precursorMz = document.getElementById("precursorMz").value;
            var experimentId = document.getElementById("experimentId").value;
            $.ajax({
                type: "POST",
                url: "/library/search",
                data: {
                    fragmentSequence: fragmentSequence,
                    libraryId: libraryId,
                    experimentId: experimentId,
                    precursorMz: precursorMz
                },
                dataType: "json",
                async: false,
                success: function (result) {
                    if (result.success) {
                        peptides = result.model.peptides;
                        if (peptides == null || peptides.length === 0) {
                            searchResult.innerText = "No Similar Peptide";
                        } else {
                            var result = "";
                            for (var i = 0; i < peptides.length; i++) {
                                result += "<label>" + peptides[i] + "</label><br>";
                            }
                            searchResult.innerHTML = result;
                        }
                    }
                }
            });
        }

        /*<![CDATA[*/
        var data_rt = [[${rt}]];
        var cutinfo = [[${totalCutInfos}]];
        var intensity_arrays = [[${intensitiesList}]];
        var bestRt = [[${bestRt}]];
        var leftRtList = [[${leftRtList}]];
        var rightRtList = [[${rightRtList}]];
        /*]]>*/
        var chart;
        var boundaryData = [];
        $(document).ready(function () {
            chart = echarts.init(document.getElementById('chart'));
            var intensity_series = [];

            if(leftRtList != null && rightRtList != null && bestRt != null){
                for (var i =0; i<leftRtList.length; i++){
                    if(bestRt < rightRtList[i] && bestRt > leftRtList[i]){
                        boundaryData.push([
                            {xAxis: leftRtList[i]+"",itemStyle:{color:'rgba(102,204,255,0.5)'}},
                            {xAxis: rightRtList[i]+""}
                        ]);
                    }else {
                        boundaryData.push([
                            {xAxis: leftRtList[i]+""},
                            {xAxis: rightRtList[i]+""}
                        ]);
                    }
                }
            }


            for (var i = 0; i < intensity_arrays.length; i++) {
                intensity_series.push({
                    name: cutinfo[i],
                    type: 'line',
                    smooth: false,
                    data: intensity_arrays[i],
                    markArea: {
                        silent: true,
                        data: boundaryData
                    }
                });
            }

            option = {
                legend: {
                    data: cutinfo.sort(),
                    align: 'left'
                },
                dataZoom: [{
                    type: 'inside',
                    filterMode: 'empty',
                    start: (chart.getModel() && chart.getModel().getOption().dataZoom[0].start) ? chart.getModel().getOption().dataZoom[0].start : 0,
                    end: (chart.getModel() && chart.getModel().getOption().dataZoom[0].end) ? chart.getModel().getOption().dataZoom[0].end : 100
                }, {
                    type: 'slider'
                }],
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        var showBion = "";
                        var showYion = "";
                        params = params.sort(function (m, n) {
                            if (m.data < n.data) return -1;
                            else if (m.data > n.data) return 1;
                            else return 0
                        });

                        var rt = "";
                        for (var i = 0; i < params.length; i++) {
                            if (params[i].data !== 0) {
                                if (params[i].seriesName.slice(0, 1) === "b") {
                                    showBion += params[i].marker + params[i].seriesName + ':' + params[i].data + '<br>'
                                } else {
                                    showYion += params[i].marker + params[i].seriesName + ':' + params[i].data + '<br>'
                                }
                            }
                            rt = params[i].axisValue;
                        }
                        if (showBion === "") {
                            return "<div class='row' style='width: 400px;'><div class='col-12'>RT:" + rt + "</div><div class='col-6'>" + showYion + "</div></div>";
                        } else {
                            return "<div class='row' style='width: 400px;'><div class='col-12'>RT:" + rt + "</div><div class='col-6'>" + showBion + "</div><div class='col-6'>" + showYion + "</div></div>";
                        }
                    },
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                xAxis: {
                    data: data_rt,
                    silent: false,
                    splitLine: {
                        show: false
                    }
                },
                yAxis: {},
                series: intensity_series
            };

            chart.setOption(option, true);
        });


    </script>
</th:block>

<!-- end::Body -->
</html>
